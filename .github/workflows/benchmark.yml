name: Benchmark

on:
  push:
    branches:
      - master

  workflow_dispatch:

concurrency:
  group: benchmark-master
  cancel-in-progress: true

jobs:
  benchmark-bun:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build and run benchmark
        run: |
          bun build benchmark/find.ts --outfile benchmark/find.js --target=node
          bun run benchmark/find.ts

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results-bun
          path: benchmark_results_bun.json

      - name: Upload built benchmark file
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-built-file
          path: benchmark/find.js

  benchmark-node:
    runs-on: ubuntu-latest
    needs: benchmark-bun

    strategy:
      matrix:
        node-version: [20, 22, 24]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Download built benchmark file
        uses: actions/download-artifact@v4
        with:
          name: benchmark-built-file
          path: benchmark

      - name: Install dependencies
        run: npm install

      - name: Run benchmark
        run: node benchmark/find.js

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results-node-${{ matrix.node-version }}
          path: benchmark_results_node_${{ matrix.node-version }}.json

  push-benchmark-results:
    needs: [benchmark-node, benchmark-bun]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          path: ./temp_benchmarks

      - name: Move benchmark results to root
        run: |
          mkdir -p benchmarks
          for file in temp_benchmarks/*/*; do
            cp "$file" benchmarks/
          done
          ls -la benchmarks/

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create or switch to benchmark branch
        run: |
          git fetch origin benchmark 2>/dev/null || echo "Branch does not exist yet"

          # Check if benchmark branch exists
          if git show-ref --verify --quiet refs/heads/benchmark; then
            # Branch exists, just checkout
            git checkout benchmark
          else
            # Branch doesn't exist, create orphan branch
            git checkout --orphan benchmark
            git reset --hard
          fi

          git add benchmarks
          git status
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add/update benchmark results [skip ci]"
            git push -u origin benchmark --force
          fi
